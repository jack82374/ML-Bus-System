{% load static %}
<!doctype html>
<html lang="en-GB">
  <head>
    <script src="{% static 'maplibre-gl.js' %}"></script>
  	<link href="{% static 'maplibre-gl.css' %}" rel="stylesheet" />
    <!--<script src="https://unpkg.com/maplibre-gl@^5.1.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@^5.1.0/dist/maplibre-gl.css" rel="stylesheet" />-->
    <meta charset="utf-8" />
    <title>ML Bus</title>
    <style>
      body { margin: 0; padding: 0; text-align: center;}
      html, body, #map { height: 100%; }
      /*.hidden {
        display: none;
      }*/
    </style>
  </head>
  <body>
    <h1>Welcome to the ML Bus System</h1>
    <h2>The map below displays live buses. 205 buses are red, 208 buses are blue!</h2>
    <div id="map"></div>
    <script>
        var markers = [];
        var dynamic_markers = [];
        //var dynamic_markers = [];
        var map = new maplibregl.Map({
            container: 'map', // container id
            //style: 'https://demotiles.maplibre.org/style.json', // style URL
            //style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            //style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
            style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
            // Attribute this to https://carto.com/blog/new-voyager-basemap somewhere
            //style: 'https://raw.githubusercontent.com/go2garret/maps/main/src/assets/json/openStreetMap.json',
            center: [-8.4710, 51.8991], // starting position [lng, lat]
            zoom: 14 // starting zoom
        });
      function fetchStops() {  
        fetch('/website/stops/')
          .then(response => response.json())
          .then(data => {
            const stop_img = new Image(20, 20); // Set the desired size
            stop_img.src = "{% static '/images/bus_stop_black.svg' %}";
            stop_img.alt = "Bus Stop Icon";
            markers = data.map(stop => {
              const markerElement = document.createElement('div');
              markerElement.appendChild(stop_img.cloneNode(true));
              markerElement.className = 'stop_marker';
              markerElement.dataset.stopName = stop.stop_name;

              const marker = new maplibregl.Marker({
                  element: markerElement
              })
              .setLngLat([stop.stop_lon, stop.stop_lat])
              .setPopup(new maplibregl.Popup().setText(stop.stop_name))
              .addTo(map);
              return { marker, markerElement };
            });
            //updateVisibleMarkers();
          });
      }

      const call_locations = setInterval(fetchLocations, 30000);

      function fetchLocations() {
        dynamic_markers.forEach(markerEntry => {
          markerEntry.marker.remove();
        });
        //var dynamic_markers = [];
        fetch('/website/locations/')
        .then(response => response.json())
        .then(data => {
          const five_bus_img = new Image(20, 20); // Set the desired size
          five_bus_img.src = "{% static '/images/bus_red.svg' %}";
          five_bus_img.alt = "205 Red Moving Bus Icon";

          const eight_bus_img = new Image(20, 20); // Set the desired size
          eight_bus_img.src = "{% static '/images/bus_blue.svg' %}";
          eight_bus_img.alt = "205 Red Moving Bus Icon";

          dynamic_markers = data.map(position => { 
            const markerElement = document.createElement('div');
            if (position.route_id == '4497_87337') {
            const location_string = position.trip_id.concat(" on route ", "205");
            markerElement.appendChild(five_bus_img.cloneNode(true));
            markerElement.className = 'bus_marker';
            markerElement.dataset.trip = position.trip_id;
    
            const marker = new maplibregl.Marker({
                element: markerElement
            })
            .setLngLat([position.longitude, position.latitude])
            .setPopup(new maplibregl.Popup().setText(location_string))
            .addTo(map);
            return { marker, markerElement };
          }
            else if (position.route_id == '4497_87340') {
            const location_string = position.trip_id.concat(" on route ", "208");
            markerElement.appendChild(eight_bus_img.cloneNode(true));
            markerElement.className = 'bus_marker';
            markerElement.dataset.trip = position.trip_id;
    
            const marker = new maplibregl.Marker({
                element: markerElement
            })
            .setLngLat([position.longitude, position.latitude])
            .setPopup(new maplibregl.Popup().setText(location_string))
            .addTo(map);
            return { marker, markerElement };
            }
          });
          //updateVisibleMarkers();
        });
        //markers = markers.concat(dynamic_markers)
      }

        /*function updateVisibleMarkers() {
          const currentZoom = map.getZoom();
          const bounds = map.getBounds();
          markers.forEach(({ marker, markerElement }) => {
              if (currentZoom < 10 && markerElement.className == 'bus_marker') {
                markerElement.classList.add('hidden'); // Hide the markers
              }
              else if (currentZoom < 7 && markerElement.className == 'stop_marker') {
                markerElement.classList.add('hidden'); // Hide the markers
              }
              //else {
              //  markerElement.classList.remove('hidden'); // Show the marker
              //}
              const lngLat = marker.getLngLat();
              if (bounds.contains(lngLat) && currentZoom > 7 && markerElement.className == 'stop_marker') {
                  markerElement.classList.remove('hidden');
              }
              else if (bounds.contains(lngLat) && currentZoom > 10 && markerElement.className == 'bus_marker') {
                markerElement.classList.remove('hidden');
              }
              //else {
              //    markerElement.classList.add('hidden');
              //}
          });
      }*/

        fetchStops();
        fetchLocations();

        

        //map.on('move', updateVisibleMarkers);
        //map.on('zoom', updateVisibleMarkers);
    </script>
  </body>
</html>